---
sort: 1
---
## 基础概念
&emsp;&emsp;永磁同步电机的定子是一个三相对称正弦波绕组，转子上粘贴有永磁体。我们知道，在一个固定的磁场中，永磁体会旋转并固定在一个平行于磁场的方向。一个典型的例子就是在地球磁场下的指南针，指南针会转动到指向地磁南北极的方向。同样的，如果这个固定的磁场开始转动，那么永磁体也会跟着转动，尽量跟随平行磁场方向，这样我们就可以通过旋转磁场来令永磁体旋转到指定角度。同时，永磁体在磁场中产生的力矩大小和永磁体与磁场方向的夹角有关，所以我们也可以通过控制磁场和永磁体的夹角来控制永磁体产生的力矩。<br>
&emsp;&emsp;回到电机的角度来说，就是我们可以通过控制定子上三个绕组电压的大小与通断，来控制转子的角度位置和输出力矩。而这种控制方法就是永磁同步电机的矢量控制（Field-Oriented Control，以下简称FOC）。

## FOC控制简介
&emsp;&emsp;FOC控制有许多独特的优势，它可以让我们对永磁同步电机进行“像素级”的控制，实现很多传统电机控制方法所无法达到的效果：
1. 可以在低转速下保持精确控制；
2. 可以很好地实现电机换向旋转；
3. 能够对电机进行力矩、速度、位置三个闭环控制；
4. FOC控制的永磁同步电机噪音较小。
正如永磁同步电机概述节所述，FOC控制的基础就是旋转磁场。在图1的磁场矢量中，我们看到电机定子的三个线圈a、b、c可以产生三个方向的磁场Ba、Bb、Bc 它们能合成电机中的磁场B。FOC控制器根据当前永磁体转子的角度、角速度、期望的输出力矩以及采样测量得到的a、b、c三个线圈的电流，计算得到三个线圈的电压通断状态与通断时间，进而通过MOS管来控制三个线圈的电压通断。这样就可以合成我们期望的磁场B，进而拖动电机转子按照我们期望的方式运动。

## 电机硬件与编码器概述
&emsp;&emsp;机器人关节电机的核心构件是电机驱动板、定子、转子和行星减速器。因为电机适合在高转速低力矩的工况下工作，而我们的机器人需要的是低转速高力矩，因此电机转子需要通过一个减速器减速之后，再输出力矩。<br>
&emsp;&emsp;编码器（encoder）是用来测量旋转角度的传感器。编码器分为增量编码器、多圈绝对位置编码器与单圈绝对位置编码器等多种。我们在此只详细讨论关节电机实际应用的单圈绝对位置编码器。<br>
&emsp;&emsp;关节电机的单圈绝对位置编码器安装在电机转子上。对于单圈绝对位置编码器（以下简称编码器），可以将它当做一个“时钟表盘”。我们每次看表的时候，都可以读到当前的日期和时间，例如4月1日23点。如果时间经过了2个小时，那么时钟转过了4月1日24点，日期会增加1天变成4月2日，时间重新从0点开始计时，变成了4月2日1点。为了方便计算经过的时间，我们也可以说现在是4月1日25点。看上去25点超过了一天24个小时的范围，实际上是因为日期增加了1天。<br>
&emsp;&emsp;单圈绝对位置编码器也是同样的道理。每次开机上电后，我们的转子可能处于任意位置，编码器会告诉我们转子所处的角度位置（0至2之间的某个值）。如果转子旋转转过了2这个角度位置，编码器也能够记录转过的圈数增加了1，从而输出一个超出0至2范围的角度位置。看上去编码器也能够输出超过一圈的角度位置，那么为什么叫它“单圈”绝对位置编码器呢？原因在于这种编码器在断电之后不能够储存之前旋转的圈数，我们以下面这个例子来说明。<br>
&emsp;&emsp;假设当前编码器输出的角度值为2.3，这意味着编码器在开机之后经过了2，旋转圈数从0变为1，同时编码器当前位于0.3 这个位置。此刻我们将编码器关机，不做任何旋转，再将编码器开机，那么此时编码器输出的角度值就会变为0.3。因为关机之后旋转圈数重置为0，所以编码器只会输出当前位置0.3。

## 电机的混合控制
&emsp;&emsp;关节电机作为一个高度集成的动力单元，其内部已经封装了电机底层的控制算法。作为用户，只需要给关节电机发送相关的命令，电机就能完成从接收命令到关节力矩输出的全部工作。<br>
&emsp;&emsp;对于电机的底层控制算法，唯一需要的控制目标就是输出力矩。可是对于机器人，我们通常需要给关节设定位置、速度和力矩。这时就需要对关节电机进行混合控制。<br>
&emsp;&emsp;宇树科技的关节电机包含如下 5 个控制指令：
1. 前馈力矩：$$\tau_{ff}$$
2. 期望角度位置：$$p_{des}$$
3. 期望角速度：$$\omega_{des}$$
4. 位置刚度： $$k_p$$
5. 速度刚度（阻尼）： $$k_d$$ 
<br>
&emsp;&emsp;在关节电机的混合控制中，使用PD控制器将电机在输出位置的偏差反馈到力矩输出上：<br>
<center>
$$ \tau = \tau_{ff} + k_p (p_{des} - p) + k_d (\omega_{des} - \omega)  $$
</center>
&emsp;&emsp;上式中，$$\tau$$为关节电机的电机转子输出力矩，$$p$$为电机转子的当前角度位置，$$\omega$$为电机转子的角速度。在实际使用关节电机时，需要注意将电机输出端的控制目标量与发送的电机转子的指令进行换算。
